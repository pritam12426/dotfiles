#!/bin/bash
# export NNN_PLUG="p:personal/ffplay_format_titlelist"
#
# Description: Play multiple media files, one after another in NNN file manager
#
# Dependencies: ffplay, ffprobe, bc
#
# Shell: Bash
# Author: Pritam <https://github.com/pritam12426>

format_seconds() {
	local seconds=$1
	local hours=$((seconds / 3600))
	local minutes=$(((seconds % 3600) / 60))
	local remaining_seconds=$((seconds % 60))

	printf "%02d:%02d:%02d" "$hours" "$minutes" "$remaining_seconds"
}

ffplay_format_title() {
	local file="$1"
	local extension="${file##*.}"
	local title_option=""
	local time=""
	local video_title=""
	local fps=""
	local bitrate=""

	# case-insensitive ext
	extension="${extension,,}"

	video_title=$(ffprobe -v error \
		-show_entries format_tags=title \
		-of default=noprint_wrappers=1:nokey=1 "$file")

	if [ -z "$video_title" ]; then
		video_title=$(basename "$file" | tr '_' ' ')
	fi

	# sanitize
	video_title=$(printf "%s" "$video_title" | tr '\n' ' ')

	title_option=", "

	if [[ $extension == "mp3" || $extension == "m4a" || $extension == "wav" ]]; then
		bitrate=$(ffprobe -v error -select_streams a:0 \
			-show_entries stream=bit_rate \
			-of default=noprint_wrappers=1:nokey=1 "$file")

		bitrate=${bitrate:-0}
		bitrate=$(printf "%.0f" "$(bc <<< "$bitrate/1000")")

		title_option+="'${bitrate}kbps'"

	elif [[ $extension == "mp4" || $extension == "mkv" || $extension == "mov" || $extension == "webm" || $extension == "part" ]]; then

		local w h
		w=$(ffprobe -v error -select_streams v:0 -show_entries stream=width  -of csv=p=0 "$file")
		h=$(ffprobe -v error -select_streams v:0 -show_entries stream=height -of csv=p=0 "$file")

		title_option+="'${w}x${h}p' • '"

		fps=$(ffprobe -v error -select_streams v:0 \
			-show_entries stream=r_frame_rate,avg_frame_rate \
			-of default=noprint_wrappers=1:nokey=1 "$file" | head -n1)

		fps=$(bc -l <<< "$fps")
		title_option+="$(printf "%.0f" "$fps")fps'"
	fi

	time=$(ffprobe -v error -show_entries format=duration \
		-of default=noprint_wrappers=1:nokey=1 "$file")

	time=$(printf "%.0f" "$time")

	title_option+=" • '$(format_seconds "$time")'"

	printf "%s%s\n" "$video_title" "$title_option"
}

BOLD_BRIGHT_CYAN='\033[1;96m'
BOLD_BRIGHT_YELLOW='\033[1;93m'
NC='\033[0m'

sel="${NNN_SEL:-${XDG_CONFIG_HOME:-$HOME/.config}/nnn/.selection}"

# ───── Selection exists ─────
targets=()
total_items=0
if [ -s "$sel" ]; then
	while IFS= read -r -d '' i || [ -n "$i" ]; do
		[[ -f $i ]] || continue
		targets+=("$(readlink -f -- "$i")")
		((total_items++))
	done < "$sel"
# ───── No selection → current file ($1) ─────
else
	[[ -f $1 ]] || exit 0
	targets+=("$(readlink -f -- "$1")")
	((total_items++))
fi

# ───── Nothing to play ─────
if ((total_items == 0)); then
	[ -s "$sel" ] && [ -p "$NNN_PIPE" ] && printf "-" > "$NNN_PIPE"
	exit 1
fi

# ───── Single file ─────
if ((total_items == 1)); then
	TITLE=$(ffplay_format_title "${targets[0]}")
	ffplay -loglevel warning -loop 0 -seek_interval 5 -window_title "$TITLE" "${targets[0]}"
	exit $?
fi

# ───── Playlist mode ─────
_i=1
printf "The playlist with %d items:\n" $total_items >&2
for i in "${targets[@]}"; do
	printf " \t %d - %s/${BOLD_BRIGHT_YELLOW}%s${NC}\n" $_i "$(dirname "$i")" "$(basename "$i")" >&2
	((_i++))
done
printf '%*s\n' "$(tput cols)" '' | tr ' ' '-' >&2

_i=1
for i in "${targets[@]}"; do
	printf "===> [ Playing ( %d/%d )  ${BOLD_BRIGHT_CYAN}%s${NC} ] <=== \n" "$_i" "$total_items" "$(basename "$i")"
	TITLE=$(ffplay_format_title "$i")
	ffplay -loglevel warning -loop 0 -seek_interval 5 -window_title "$TITLE" "$i"
	printf '%*s\n' "$(tput cols)" '' | tr ' ' '-' >&2
	((_i++))
done

[ -s "$sel" ] && [ -p "$NNN_PIPE" ] && printf "-" > "$NNN_PIPE"
